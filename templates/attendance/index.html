{% extends "base.html" %} {% block title %}Presensi - Sistem Presensi Karyawan{%
endblock %} {% block content %}
<div
  class="space-y-6 animate-in fade-in slide-in-from-bottom-4"
  data-office-lat="{{ office_location.latitude }}"
  data-office-lng="{{ office_location.longitude }}"
  data-office-radius="{{ office_location.radius }}"
>
  <!-- Header -->
  <div
    class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
  >
    <div class="space-y-1">
      <h1 class="text-3xl sm:text-4xl font-bold tracking-tight gradient-text">
        Presensi
      </h1>
      <p class="text-muted-foreground">
        {% if role == 'karyawan' %} Lakukan presensi masuk dan pulang {% else %}
        Monitor presensi karyawan {% endif %}
      </p>
    </div>
  </div>

  {% if role == 'karyawan' %}
  <!-- Map Section -->
  <div
    class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm shadow-lg p-6"
  >
    <h2 class="text-xl font-bold text-slate-800 mb-4">Peta Lokasi Absen</h2>
    <p class="text-sm text-slate-600 mb-4">
      <i class="fas fa-info-circle mr-1"></i>
      Peta menunjukkan posisi kantor (marker biru) dan radius absen (lingkaran
      hijau). Posisi Anda saat ini akan ditampilkan saat melakukan presensi.
    </p>
    <div
      id="attendanceMap"
      class="w-full h-64 sm:h-80 rounded-xl border border-slate-200 overflow-hidden"
    ></div>
    <div class="mt-4 flex flex-wrap gap-4 text-sm">
      <div class="flex items-center gap-2">
        <div
          class="w-4 h-4 rounded-full bg-blue-600 border-2 border-white shadow"
        ></div>
        <span class="text-slate-700">Posisi Kantor</span>
      </div>
      <div class="flex items-center gap-2">
        <div
          class="w-4 h-4 rounded-full bg-green-500 border-2 border-white shadow"
        ></div>
        <span class="text-slate-700"
          >Radius Absen ({{ office_location.radius }}m)</span
        >
      </div>
      <div class="flex items-center gap-2">
        <div
          class="w-4 h-4 rounded-full bg-red-600 border-2 border-white shadow"
        ></div>
        <span class="text-slate-700">Posisi Anda</span>
      </div>
    </div>
  </div>

  <!-- Today's Attendance Card -->
  <div
    class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm shadow-lg p-6"
  >
    <h2 class="text-xl font-bold text-slate-800 mb-6">Presensi Hari Ini</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Check In -->
      <div
        class="rounded-xl border-2 border-dashed border-slate-300 bg-gradient-to-br from-blue-50/50 to-white p-6 text-center transition-all hover:shadow-lg"
      >
        <div
          class="flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 mx-auto mb-4 shadow-lg"
        >
          <i class="fas fa-sign-in-alt text-2xl text-white"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-800 mb-2">Check In</h3>
        {% if today_attendance and today_attendance.check_in_time %}
        <p class="text-slate-600 font-medium">
          Waktu: {{ today_attendance.check_in_time.strftime('%H:%M:%S') }}
        </p>
        <p class="text-sm text-slate-500 mt-2">
          Status:
          <span
            class="font-semibold {% if today_attendance.status == 'hadir' %}text-green-600{% else %}text-red-600{% endif %}"
          >
            {{ today_attendance.status|upper }}
          </span>
        </p>
        <button
          disabled
          class="mt-4 px-6 py-2 bg-slate-300 text-slate-600 rounded-xl cursor-not-allowed font-semibold"
        >
          Sudah Check In
        </button>
        {% else %}
        <button
          id="checkInBtn"
          class="mt-4 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 transition-all"
        >
          Check In
        </button>
        {% endif %}
      </div>

      <!-- Check Out -->
      <div
        class="rounded-xl border-2 border-dashed border-slate-300 bg-gradient-to-br from-green-50/50 to-white p-6 text-center transition-all hover:shadow-lg"
      >
        <div
          class="flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-green-500 to-green-600 mx-auto mb-4 shadow-lg"
        >
          <i class="fas fa-sign-out-alt text-2xl text-white"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-800 mb-2">Check Out</h3>
        {% if today_attendance and today_attendance.check_out_time %}
        <p class="text-slate-600 font-medium">
          Waktu: {{ today_attendance.check_out_time.strftime('%H:%M:%S') }}
        </p>
        <button
          disabled
          class="mt-4 px-6 py-2 bg-slate-300 text-slate-600 rounded-xl cursor-not-allowed font-semibold"
        >
          Sudah Check Out
        </button>
        {% elif today_attendance and today_attendance.check_in_time %}
        <button
          id="checkOutBtn"
          class="mt-4 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 transition-all"
        >
          Check Out
        </button>
        {% else %}
        <p class="text-slate-500 mt-4 font-medium">
          Silakan check in terlebih dahulu
        </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Manual Request Section (Ajukan Cuti Manual untuk Lupa Absen) -->
  <div
    class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm shadow-lg p-6"
  >
    <div class="flex items-center gap-3 mb-4">
      <div
        class="flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 shadow-lg"
      >
        <i class="fas fa-calendar-times text-xl text-white"></i>
      </div>
      <div>
        <h2 class="text-xl font-bold text-slate-800">
          Ajukan Cuti Manual (Lupa Absen)
        </h2>
        <p class="text-sm text-slate-600">
          Untuk tanggal yang lupa melakukan presensi
        </p>
      </div>
    </div>

    <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
      <p class="text-sm text-yellow-800">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <strong>Perhatian:</strong> Gunakan fitur ini hanya jika Anda
        benar-benar lupa melakukan presensi pada tanggal tertentu.
      </p>
    </div>

    <form id="manualRequestForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label
            for="manual_attendance_date"
            class="block text-sm font-semibold text-slate-700 mb-2"
          >
            Tanggal Lupa Absen *
          </label>
          <input
            type="date"
            id="manual_attendance_date"
            name="attendance_date"
            required
            max="{{ current_date.strftime('%Y-%m-%d') }}"
            class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
          <p class="text-xs text-slate-500 mt-1">
            Pilih tanggal dimana Anda lupa melakukan presensi
          </p>
        </div>

        <div>
          <label
            for="manual_status"
            class="block text-sm font-semibold text-slate-700 mb-2"
          >
            Status *
          </label>
          <select
            id="manual_status"
            name="status"
            required
            class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="wfa" selected>WFA (Work From Anywhere)</option>
            <option value="hadir">WFO (Work From Office)</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">
            Pilih status untuk presensi manual ini
          </p>
        </div>
      </div>

      <div>
        <label
          for="manual_notes"
          class="block text-sm font-semibold text-slate-700 mb-2"
        >
          Alasan / Keterangan *
        </label>
        <textarea
          id="manual_notes"
          name="notes"
          rows="4"
          required
          placeholder="Jelaskan alasan mengapa Anda tidak melakukan presensi pada tanggal tersebut..."
          class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
        ></textarea>
        <p class="text-xs text-slate-500 mt-1">
          Berikan alasan yang jelas dan detail
        </p>
      </div>

      <div
        class="flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg"
      >
        <i class="fas fa-map-marker-alt text-blue-600"></i>
        <span class="text-sm text-blue-700">
          Lokasi Anda akan otomatis diambil saat submit untuk keamanan
        </span>
      </div>

      <button
        type="submit"
        id="submitManualRequestBtn"
        class="w-full md:w-auto px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 transition-all"
      >
        <i class="fas fa-paper-plane mr-2"></i>Ajukan Cuti Manual
      </button>
    </form>
  </div>
  {% else %}
  <!-- Info untuk Admin/HRD/Atasan -->
  <div
    class="rounded-xl border border-blue-200 bg-gradient-to-r from-blue-50 to-indigo-50 p-4"
  >
    <div class="flex items-start gap-3">
      <div
        class="flex h-8 w-8 items-center justify-center rounded-lg bg-blue-500/20 flex-shrink-0"
      >
        <i class="fas fa-info-circle text-blue-600"></i>
      </div>
      <div class="flex-1">
        <p class="text-sm text-slate-700">
          <strong>Info:</strong> Sebagai
          <span class="font-bold">{{ role|upper }}</span>, Anda dapat melihat
          riwayat presensi di halaman
          <a
            href="{{ url_for('attendance.history') }}"
            class="text-blue-600 hover:text-blue-800 underline font-semibold"
            >Riwayat Presensi</a
          >. {% if role in ['admin', 'hrd'] %} Untuk mengelola data karyawan,
          silakan kunjungi halaman
          <a
            href="{{ url_for('employee.index') }}"
            class="text-blue-600 hover:text-blue-800 underline font-semibold"
            >Data Karyawan</a
          >. {% endif %}
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Attendance History Summary -->
  <div
    class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm shadow-lg p-4 sm:p-6"
  >
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4"
    >
      <h2 class="text-xl font-bold text-slate-800">
        {% if role == 'karyawan' %} Riwayat Presensi Saya {% else %} Riwayat
        Presensi {% endif %}
      </h2>
      <a
        href="{{ url_for('attendance.history') }}"
        class="inline-flex items-center text-blue-600 hover:text-blue-800 font-semibold transition-all hover:scale-105"
      >
        Lihat Semua <i class="fas fa-arrow-right ml-2"></i>
      </a>
    </div>

    <!-- Table View (Responsive with horizontal scroll) -->
    <div class="overflow-x-auto">
      <table class="w-full min-w-[700px] caption-bottom text-sm">
        <thead>
          <tr
            class="border-b border-slate-200 bg-gradient-to-r from-slate-50 to-slate-100/50"
          >
            <th
              class="h-12 px-4 text-left align-middle font-bold text-slate-700"
            >
              Tanggal
            </th>
            {% if role != 'karyawan' %}
            <th
              class="h-12 px-4 text-left align-middle font-bold text-slate-700"
            >
              Karyawan
            </th>
            {% endif %}
            <th
              class="h-12 px-4 text-left align-middle font-bold text-slate-700"
            >
              Check In
            </th>
            <th
              class="h-12 px-4 text-left align-middle font-bold text-slate-700"
            >
              Check Out
            </th>
            <th
              class="h-12 px-4 text-left align-middle font-bold text-slate-700"
            >
              Status
            </th>
            <th
              class="h-12 px-4 text-left align-middle font-bold text-slate-700"
            >
              Keterangan
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {% for attendance in attendances[:10] %}
          <tr
            class="border-b border-slate-100 transition-all hover:bg-gradient-to-r hover:from-blue-50/50 hover:to-transparent"
          >
            <td class="p-4 align-middle">
              <div class="text-sm font-semibold text-slate-800">
                {{ attendance.attendance_date.strftime('%d/%m/%Y') }}
              </div>
            </td>
            {% if role != 'karyawan' %}
            <td class="p-4 align-middle">
              <div class="font-semibold text-slate-800">
                {{ attendance.employee.full_name if attendance.employee else '-'
                }}
              </div>
            </td>
            {% endif %}
            <td class="p-4 align-middle">
              <div class="text-sm text-slate-700">
                {% if attendance.check_in_time %} {{
                attendance.check_in_time.strftime('%H:%M:%S') }} {% else %}
                <span class="text-slate-400">-</span>
                {% endif %}
              </div>
            </td>
            <td class="p-4 align-middle">
              <div class="text-sm text-slate-700">
                {% if attendance.check_out_time %} {{
                attendance.check_out_time.strftime('%H:%M:%S') }} {% else %}
                <span class="text-slate-400">-</span>
                {% endif %}
              </div>
            </td>
            <td class="p-4 align-middle">
              <span
                class="inline-flex items-center rounded-full px-3 py-1.5 text-xs font-bold transition-all shadow-md {% if attendance.status == 'hadir' %}bg-gradient-to-r from-green-500 to-green-600 text-white {% elif attendance.status == 'terlambat' %}bg-gradient-to-r from-yellow-500 to-yellow-600 text-white {% elif attendance.status == 'pulang_cepat' %}bg-gradient-to-r from-orange-500 to-orange-600 text-white {% elif attendance.status == 'wfa' %}bg-gradient-to-r from-blue-500 to-indigo-600 text-white {% else %}bg-gradient-to-r from-red-500 to-red-600 text-white{% endif %}"
              >
                {{ attendance.status|upper|replace('_', ' ') }}
              </span>
            </td>
            <td class="p-4 align-middle">
              <div
                class="text-sm text-slate-600 max-w-xs truncate"
                title="{{ attendance.notes or '-' }}"
              >
                {{ attendance.notes or '-' }}
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td
              colspan="{% if role != 'karyawan' %}6{% else %}5{% endif %}"
              class="h-24 text-center"
            >
              <div class="flex flex-col items-center gap-2">
                <i class="fas fa-inbox text-4xl text-slate-300"></i>
                <div class="text-slate-500 font-medium">
                  Tidak ada data presensi
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div
  id="loadingModal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
>
  <div
    class="fixed inset-0 bg-black/50 backdrop-blur-sm"
    onclick="document.getElementById('loadingModal').classList.add('hidden')"
  ></div>
  <div
    class="relative z-50 rounded-2xl border bg-white p-8 text-center shadow-2xl"
  >
    <div
      class="flex h-16 w-16 items-center justify-center rounded-full bg-blue-100 mx-auto mb-4"
    >
      <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
    </div>
    <p class="text-slate-700 font-semibold">Memproses presensi...</p>
  </div>
</div>
{% endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  #attendanceMap {
    z-index: 1;
  }
</style>
{% endblock %} {% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Initialize Map - Get data from data attributes
  let officeLat,
    officeLng,
    officeRadius,
    map,
    officeMarker,
    radiusCircle,
    userMarker;

  document.addEventListener("DOMContentLoaded", function () {
    const container = document.querySelector("[data-office-lat]");
    if (!container) return;

    officeLat = parseFloat(container.getAttribute("data-office-lat"));
    officeLng = parseFloat(container.getAttribute("data-office-lng"));
    officeRadius = parseFloat(container.getAttribute("data-office-radius"));

    // Initialize map centered on office
    map = L.map("attendanceMap").setView([officeLat, officeLng], 16);

    // Add OpenStreetMap tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
      maxZoom: 19,
    }).addTo(map);

    // Add office marker
    officeMarker = L.marker([officeLat, officeLng], {
      icon: L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
        shadowUrl:
          "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      }),
    }).addTo(map);
    officeMarker
      .bindPopup(
        "<b>Lokasi Kantor</b><br>Koordinat: " + officeLat + ", " + officeLng
      )
      .openPopup();

    // Add radius circle
    radiusCircle = L.circle([officeLat, officeLng], {
      color: "#22c55e",
      fillColor: "#22c55e",
      fillOpacity: 0.2,
      radius: officeRadius,
    }).addTo(map);

    // Try to get current location on page load
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function (position) {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;

          // Add user marker
          userMarker = L.marker([userLat, userLng], {
            icon: L.icon({
              iconUrl:
                "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
              shadowUrl:
                "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41],
            }),
          }).addTo(map);
          userMarker.bindPopup(
            "<b>Posisi Anda Saat Ini</b><br>Koordinat: " +
              userLat +
              ", " +
              userLng
          );

          // Calculate and show distance
          const distance = calculateDistance(
            officeLat,
            officeLng,
            userLat,
            userLng
          );
          const isInRange = distance <= officeRadius;
          userMarker
            .bindPopup(
              "<b>Posisi Anda Saat Ini</b><br>" +
                "Koordinat: " +
                userLat.toFixed(6) +
                ", " +
                userLng.toFixed(6) +
                "<br>" +
                "Jarak: " +
                Math.round(distance) +
                "m<br>" +
                '<span style="color: ' +
                (isInRange ? "green" : "red") +
                '; font-weight: bold;">' +
                (isInRange ? "✓ Dalam Radius" : "✗ Di Luar Radius") +
                "</span>"
            )
            .openPopup();

          // Adjust map view to show both markers
          const group = new L.featureGroup([
            officeMarker,
            userMarker,
            radiusCircle,
          ]);
          map.fitBounds(group.getBounds().pad(0.1));
        },
        function (error) {
          console.log("Tidak dapat mendapatkan lokasi: " + error.message);
        }
      );
    }
  });

  function getLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject("Geolocation tidak didukung oleh browser Anda");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) =>
          resolve({
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
          }),
        (error) => reject("Tidak dapat mendapatkan lokasi: " + error.message)
      );
    });
  }

  async function checkIn() {
    const modal = document.getElementById("loadingModal");
    modal.classList.remove("hidden");

    try {
      const location = await getLocation();

      // Update user marker on map
      if (userMarker) {
        map.removeLayer(userMarker);
      }
      userMarker = L.marker([location.latitude, location.longitude], {
        icon: L.icon({
          iconUrl:
            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
          shadowUrl:
            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41],
        }),
      }).addTo(map);
      userMarker.bindPopup(
        "<b>Posisi Anda</b><br>Koordinat: " +
          location.latitude +
          ", " +
          location.longitude
      );

      // Calculate distance
      const distance = calculateDistance(
        officeLat,
        officeLng,
        location.latitude,
        location.longitude
      );
      const isInRange = distance <= officeRadius;

      // Update map view to show both markers
      const group = new L.featureGroup([
        officeMarker,
        userMarker,
        radiusCircle,
      ]);
      map.fitBounds(group.getBounds().pad(0.1));

      const response = await fetch('{{ url_for("attendance.check_in") }}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(location),
      });

      const data = await response.json();
      modal.classList.add("hidden");

      if (data.success) {
        alert("Check-in berhasil!");
        window.location.reload();
      } else {
        alert("Error: " + data.message);
      }
    } catch (error) {
      modal.classList.add("hidden");
      alert("Error: " + error);
    }
  }

  async function checkOut() {
    const modal = document.getElementById("loadingModal");
    modal.classList.remove("hidden");

    try {
      const location = await getLocation();

      // Update user marker on map
      if (userMarker) {
        map.removeLayer(userMarker);
      }
      userMarker = L.marker([location.latitude, location.longitude], {
        icon: L.icon({
          iconUrl:
            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
          shadowUrl:
            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41],
        }),
      }).addTo(map);
      userMarker.bindPopup(
        "<b>Posisi Anda</b><br>Koordinat: " +
          location.latitude +
          ", " +
          location.longitude
      );

      // Update map view to show both markers
      const group = new L.featureGroup([
        officeMarker,
        userMarker,
        radiusCircle,
      ]);
      map.fitBounds(group.getBounds().pad(0.1));

      const response = await fetch('{{ url_for("attendance.check_out") }}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(location),
      });

      const data = await response.json();
      modal.classList.add("hidden");

      if (data.success) {
        alert("Check-out berhasil!");
        window.location.reload();
      } else {
        alert("Error: " + data.message);
      }
    } catch (error) {
      modal.classList.add("hidden");
      alert("Error: " + error);
    }
  }

  // Calculate distance between two coordinates (Haversine formula)
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Earth radius in meters
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLon = ((lon2 - lon1) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((lat1 * Math.PI) / 180) *
        Math.cos((lat2 * Math.PI) / 180) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  document.getElementById("checkInBtn")?.addEventListener("click", checkIn);
  document.getElementById("checkOutBtn")?.addEventListener("click", checkOut);

  // Manual Request Form Handler
  const manualRequestForm = document.getElementById("manualRequestForm");
  if (manualRequestForm) {
    manualRequestForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const modal = document.getElementById("loadingModal");
      const submitBtn = document.getElementById("submitManualRequestBtn");
      const originalBtnText = submitBtn.innerHTML;

      // Disable button and show loading
      submitBtn.disabled = true;
      submitBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
      modal.classList.remove("hidden");

      try {
        // Get location first
        const location = await getLocation();

        // Get form data
        const formData = {
          attendance_date: document.getElementById("manual_attendance_date")
            .value,
          notes: document.getElementById("manual_notes").value.trim(),
          status: document.getElementById("manual_status").value,
          latitude: location.latitude,
          longitude: location.longitude,
        };

        // Validate
        if (!formData.attendance_date) {
          throw new Error("Tanggal tidak boleh kosong");
        }
        if (!formData.notes) {
          throw new Error("Alasan tidak boleh kosong");
        }
        if (!formData.status) {
          throw new Error("Status tidak boleh kosong");
        }

        // Update user marker on map if map is available
        if (map && userMarker) {
          map.removeLayer(userMarker);
        }
        if (map) {
          userMarker = L.marker([location.latitude, location.longitude], {
            icon: L.icon({
              iconUrl:
                "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
              shadowUrl:
                "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41],
            }),
          }).addTo(map);
          userMarker.bindPopup(
            "<b>Lokasi Pengajuan</b><br>Koordinat: " +
              location.latitude.toFixed(6) +
              ", " +
              location.longitude.toFixed(6)
          );

          // Update map view
          if (officeMarker && radiusCircle) {
            const group = new L.featureGroup([
              officeMarker,
              userMarker,
              radiusCircle,
            ]);
            map.fitBounds(group.getBounds().pad(0.1));
          }
        }

        // Submit to server
        const response = await fetch(
          '{{ url_for("attendance.manual_request") }}',
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          }
        );

        const data = await response.json();
        modal.classList.add("hidden");
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;

        if (data.success) {
          alert("Pengajuan cuti manual berhasil diajukan!");
          // Reset form
          manualRequestForm.reset();
          // Reload page to show updated attendance
          window.location.reload();
        } else {
          alert("Error: " + data.message);
        }
      } catch (error) {
        modal.classList.add("hidden");
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        alert("Error: " + error.message);
      }
    });
  }
</script>
{% endblock %}
